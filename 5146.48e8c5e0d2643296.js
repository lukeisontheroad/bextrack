"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5146],{5146:(j,f,l)=>{l.d(f,{s:()=>h});var o=l(5861),p=l(8274),_=l(3790),m=l(6895),v=l(529),P=l(9265);let h=(()=>{class d{constructor(t,e,r){this.http=t,this.authService=e,this.utilsService=r,this.timesUpdated=new p.EventEmitter,this.projectsUpdated=new p.EventEmitter,this.contactsUpdated=new p.EventEmitter,this.limit=1e3,this.corsProxy="https://cors.bextrack.com/",this.baseUrl=this.corsProxy+"https://api.bexio.com/",this.users=[],this.usersMap={},this.projects=[],this.contacts=[],this.projectMap={},this.timesheets=[],this.timesheetStatus=[],this.clientServicees=[],this.packages=[],this.cachedPackagesProjectId={},this.cachedPackagesPackageId={}}init(){var t=this;return(0,o.Z)(function*(){return new Promise((e,r)=>{let i=t.authService.addActionListener(function(){var a=(0,o.Z)(function*(n){if(n.action===_.AuthActions.LoadUserInfoSuccess){t.users=yield t.http.get(t.baseUrl+"3.0/users").toPromise();for(var s=0;s<t.users.length;s++)t.usersMap[t.users[s].id]=t.users[s];try{for(yield Promise.all([t.getTimesheetStatus(!0),t.getClientService(!0),t.getProjects(!0)]),s=0;s<t.users.length;s++)t.users[s].email===n.user.email&&(t.currentUser=t.users[s],t.authService.removeActionObserver(i),e())}catch(u){r(u)}}});return function(n){return a.apply(this,arguments)}}());t.authService.loadUserInfo()})})()}getContacts(t=!1){var e=this;return(0,o.Z)(function*(){return new Promise(function(){var r=(0,o.Z)(function*(i,a){if(t||0===e.projects.length){const n=yield e.http.get(e.baseUrl+"2.0/contact/?order_by=name_1_asc").toPromise();e.contacts=n,e.contactsUpdated.next(null)}i(e.contacts)});return function(i,a){return r.apply(this,arguments)}}())})()}getProjects(t=!1){var e=this;return(0,o.Z)(function*(){return new Promise(function(){var r=(0,o.Z)(function*(i,a){try{if(t||0===e.projects.length){const u=yield e.http.post(e.baseUrl+"2.0/pr_project/search?order_by=name&limit="+e.limit,[{field:"pr_state_id",value:"2",criteria:"="}]).toPromise();e.projects=u;for(var n=0;n<e.projects.length;n++){if(e.projects[n].packages=e.cachedPackagesProjectId[e.projects[n].id],e.projects[n].packages){e.projects[n].spent_time_in_hours=0,e.projects[n].estimated_time_in_hours=0;for(var s=0;s<e.projects[n].packages.length;s++)e.projects[n].packages[s].estimated_time_in_hours&&(e.projects[n].estimated_time_in_hours+=e.projects[n].packages[s].estimated_time_in_hours),e.projects[n].packages[s]&&(e.projects[n].spent_time_in_hours+=e.projects[n].packages[s].spent_time_in_hours)}e.projectMap[e.projects[n].id]=e.projects[n]}e.projectsUpdated.next(null)}i(e.projects)}catch(u){a(u)}});return function(i,a){return r.apply(this,arguments)}}())})()}prepareTimesheetForApi(t){return delete t.travel_time,delete t.travel_charge,delete t.travel_distance,delete t.date,delete t.duration,delete t.running,delete t.user,delete t.project,delete t.package,"duration"===t.tracking.type?(delete t.tracking.start,delete t.tracking.end):(t.tracking.start=new m.DatePipe("en-US").transform(t.tracking.start,"yyyy-MM-dd HH:mm"),t.tracking.end=new m.DatePipe("en-US").transform(t.tracking.end,"yyyy-MM-dd HH:mm"),delete t.tracking.date,delete t.tracking.duration),t}putTimesheet(t){var e=this;return(0,o.Z)(function*(){let r=e.prepareTimesheetForApi(t);return delete r.tracking.type,new Promise(function(){var i=(0,o.Z)(function*(a,n){let s=yield e.http.post(e.baseUrl+"2.0/timesheet/"+t.id,r).toPromise();e.getMyTimesheets(!0),a(s)});return function(a,n){return i.apply(this,arguments)}}())})()}postTimesheet(t){var e=this;return(0,o.Z)(function*(){let r=e.prepareTimesheetForApi(t);return delete r.id,new Promise(function(){var i=(0,o.Z)(function*(a,n){let s=yield e.http.post(e.baseUrl+"2.0/timesheet",r).toPromise();e.getMyTimesheets(!0),a(s)});return function(a,n){return i.apply(this,arguments)}}())})()}deleteTimesheet(t){var e=this;return(0,o.Z)(function*(){return new Promise(function(){var r=(0,o.Z)(function*(i,a){yield e.http.delete(e.baseUrl+"2.0/timesheet/"+t).toPromise(),e.getMyTimesheets(!0),i()});return function(i,a){return r.apply(this,arguments)}}())})()}getTimesheetStatus(t=!1){var e=this;return(0,o.Z)(function*(){return new Promise(function(){var r=(0,o.Z)(function*(i,a){if(t||0===e.timesheetStatus.length)try{e.timesheetStatus=yield e.http.get(e.baseUrl+"2.0/timesheet_status").toPromise(),i(e.timesheetStatus)}catch(n){a(n)}else i(e.timesheetStatus)});return function(i,a){return r.apply(this,arguments)}}())})()}getClientService(t=!1){var e=this;return(0,o.Z)(function*(){return new Promise(function(){var r=(0,o.Z)(function*(i,a){try{(t||0===e.clientServicees.length)&&(e.clientServicees=yield e.http.get(e.baseUrl+"2.0/client_service").toPromise()),console.log("this.clientServicees",e.clientServicees),i(e.clientServicees)}catch(n){a(n)}});return function(i,a){return r.apply(this,arguments)}}())})()}getTimesheet(t,e=!1){var r=this;return(0,o.Z)(function*(){return new Promise(function(){var i=(0,o.Z)(function*(a,n){if(!e){let u=r.timesheets.filter(y=>y.id===t);if(1===u.length)return void a(u[0])}const s=yield r.http.get(r.baseUrl+"2.0/timesheet/"+t).toPromise();s.user=r.usersMap[s.user_id],s.project=r.projectMap[s.pr_project_id],s.package=r.cachedPackagesPackageId[s.pr_package_id],s.tracking=r.utilsService.prepareTracking(s.tracking),s.text=(new DOMParser).parseFromString(s.text,"text/html").documentElement.textContent,a(s)});return function(a,n){return i.apply(this,arguments)}}())})()}getMyTimesheets(t=!1){var e=this;return new Promise(function(){var r=(0,o.Z)(function*(i,a){let n=yield e.getUser(),s=yield e.getTimesheets(n.id,t);t&&e.timesUpdated.next(null),i(s)});return function(i,a){return r.apply(this,arguments)}}())}searchContact(t){var e=this;return new Promise(function(){var r=(0,o.Z)(function*(i,a){try{let n=e.http.post(e.baseUrl+"2.0/contact/search?limit=20",[{field:"name_1",value:t,criteria:"like"}]).toPromise(),s=e.http.post(e.baseUrl+"2.0/contact/search?limit=20",[{field:"name_2",value:t,criteria:"like"}]).toPromise();i([...yield n,...yield s])}catch(n){a(n)}});return function(i,a){return r.apply(this,arguments)}}())}getTimesheets(t=-1,e=!1){var r=this;return(0,o.Z)(function*(){return new Promise(function(){var i=(0,o.Z)(function*(a,n){if(e||0===r.timesheets.length){const u=[];if(t>-1){const y=[{field:"user_id",value:t,criteria:"="}];u.push(...yield yield r.http.post(r.baseUrl+"2.0/timesheet/search?order_by=date_desc,id_desc&limit=500",y).toPromise())}else u.push(...yield r.http.get(r.baseUrl+"2.0/timesheet?order_by=date_desc,id_desc").toPromise());for(var s=0;s<u.length;s++)u[s].user=r.usersMap[u[s].user_id],u[s].project=r.projectMap[u[s].pr_project_id],u[s].package=r.cachedPackagesPackageId[u[s].pr_package_id],u[s].tracking=r.utilsService.prepareTracking(u[s].tracking),u[s].text=(new DOMParser).parseFromString(u[s].text,"text/html").documentElement.textContent;r.timesheets=u}a(r.timesheets)});return function(a,n){return i.apply(this,arguments)}}())})()}getUsers(){var t=this;return new Promise(function(){var e=(0,o.Z)(function*(r,i){r(t.users)});return function(r,i){return e.apply(this,arguments)}}())}getPackages(t=!1){var e=this;return(0,o.Z)(function*(){yield e.getProjects(t);let r=[];for(var i=0;i<e.projects.length;i++){const a=e.projects[i].id;let n=e.getPackagesForProject(a).then(s=>{e.cachedPackagesProjectId[a]=s;for(var u=0;u<s.length;u++)e.cachedPackagesPackageId[s[u].id]=s;e.packages.push(...s)});r.push(n)}yield Promise.all(r),yield e.getProjects(!0),e.projectsUpdated.next(null)})()}getPackageForProjectWithId(t,e){return this.http.get(this.baseUrl+"3.0/projects/"+t+"/packages/"+e).toPromise()}getPackagesForProject(t){return this.http.get(this.baseUrl+"3.0/projects/"+t+"/packages").toPromise()}getUser(){var t=this;return(0,o.Z)(function*(){return new Promise(function(){var e=(0,o.Z)(function*(r){r(t.currentUser)});return function(r){return e.apply(this,arguments)}}())})()}}return d.\u0275fac=function(t){return new(t||d)(p.\u0275\u0275inject(v.eN),p.\u0275\u0275inject(_.AuthService),p.\u0275\u0275inject(P.F))},d.\u0275prov=p.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac,providedIn:"root"}),d})()},9265:(j,f,l)=>{l.d(f,{F:()=>P});var o=l(5861),p=l(7423),_=l(8274),g=l(8058),m=l(2466);const{LocalNotifications:v}=p.Vn;let P=(()=>{class h{constructor(c,t,e){this.toastCtroller=c,this.alertController=t,this.translateService=e}static pad(c,t=2){let e=c+"";for(;e.length<t;)e="0"+e;return e}parseBexioDate(c){if(c&&-1===c.indexOf(" "))return new Date(c);let t=c.split(" ")[0],e=c.split(" ")[1].split(":").map(i=>parseInt(i)),r=new Date(t);return r.setHours(e[0],e[1],e[2]),r}prepareTracking(c){let t=(new Date).toISOString();return["date","start","end"].forEach(e=>{c[e]=c[e]?this.parseBexioDate(c[e]).toISOString():t}),c}requestNotificationPermission(){return new Promise(function(){var c=(0,o.Z)(function*(t,e){(yield v.requestPermission())?e():t()});return function(t,e){return c.apply(this,arguments)}}())}parseDuration(c){return null===c?0:parseFloat(c)+parseFloat(c.split(":")[1])/60}showToast(c,t=3e3){var e=this;return(0,o.Z)(function*(){(yield e.toastCtroller.create({message:yield e.translateService.get(c).toPromise(),duration:t,position:"top"})).present()})()}confirm(c,t,e="Delete",r="Cancel"){var i=this;return new Promise(function(){var a=(0,o.Z)(function*(n,s){(yield i.alertController.create({header:yield i.translateService.get(c).toPromise(),message:yield i.translateService.get(t).toPromise(),buttons:[{text:yield i.translateService.get(r).toPromise(),role:"cancel",cssClass:"secondary",handler:()=>{n(!1)}},{text:yield i.translateService.get(e).toPromise(),cssClass:"danger",handler:()=>{n(!0)}}]})).present()});return function(n,s){return a.apply(this,arguments)}}())}}return h.\u0275fac=function(c){return new(c||h)(_.\u0275\u0275inject(g.ToastController),_.\u0275\u0275inject(g.AlertController),_.\u0275\u0275inject(m.sK))},h.\u0275prov=_.\u0275\u0275defineInjectable({token:h,factory:h.\u0275fac,providedIn:"root"}),h})()}}]);