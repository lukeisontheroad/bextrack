"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6929],{6929:(A,g,u)=>{u.d(g,{G:()=>_});var o=u(467),m=u(177),l=u(6996),d=u(5154),P=u(1626),v=u(9893);let _=(()=>{var p;class f{constructor(t,e,r){this.http=t,this.authService=e,this.utilsService=r,this.timesUpdated=new l.bkB,this.projectsUpdated=new l.bkB,this.contactsUpdated=new l.bkB,this.limit=300,this.corsProxy="https://cors.bextrack.com/",this.baseUrl=this.corsProxy+"https://api.bexio.com/",this.users=[],this.usersMap={},this.projects=[],this.contacts=[],this.projectMap={},this.timesheets=[],this.timesheetStatus=[],this.clientServicees=[],this.packages=[],this.cachedPackagesProjectId={},this.cachedPackagesPackageId={}}init(){var t=this;return(0,o.A)(function*(){return new Promise((e,r)=>{const i=t.authService.addActionListener(function(){var a=(0,o.A)(function*(n){if(n.action===d.AuthActions.LoadUserInfoSuccess){t.users=yield t.http.get(t.baseUrl+"3.0/users").toPromise();for(let s=0;s<t.users.length;s++)t.usersMap[t.users[s].id]=t.users[s];try{yield Promise.all([t.getTimesheetStatus(!0),t.getClientService(!0),t.getProjects(!0)]);for(let s=0;s<t.users.length;s++)t.users[s].email===n.user.email&&(t.currentUser=t.users[s],t.authService.removeActionObserver(i),e())}catch(s){r(s)}}});return function(n){return a.apply(this,arguments)}}());t.authService.loadUserInfo()})})()}getContacts(t=!1){var e=this;return(0,o.A)(function*(){return new Promise(function(){var r=(0,o.A)(function*(i){if(t||0===e.projects.length){const a=yield e.http.get(e.baseUrl+"2.0/contact/?order_by=name_1_asc").toPromise();e.contacts=a,e.contactsUpdated.next(null)}i(e.contacts)});return function(i){return r.apply(this,arguments)}}())})()}getProjects(t=!1){var e=this;return(0,o.A)(function*(){return new Promise(function(){var r=(0,o.A)(function*(i,a){try{if(t||0===e.projects.length){const n=yield e.http.post(e.baseUrl+"2.0/pr_project/search?order_by=name&limit="+e.limit,[{field:"pr_state_id",value:"2",criteria:"="}]).toPromise();e.projects=n;for(let s=0;s<e.projects.length;s++){if(e.projects[s].packages=e.cachedPackagesProjectId[e.projects[s].id],e.projects[s].packages){e.projects[s].spent_time_in_hours=0,e.projects[s].estimated_time_in_hours=0;for(let h=0;h<e.projects[s].packages.length;h++)e.projects[s].packages[h].estimated_time_in_hours&&(e.projects[s].estimated_time_in_hours+=e.projects[s].packages[h].estimated_time_in_hours),e.projects[s].packages[h]&&(e.projects[s].spent_time_in_hours+=e.projects[s].packages[h].spent_time_in_hours)}e.projectMap[e.projects[s].id]=e.projects[s]}e.projectsUpdated.next(null)}i(e.projects)}catch(n){a(n)}});return function(i,a){return r.apply(this,arguments)}}())})()}prepareTimesheetForApi(t){return delete t.travel_time,delete t.travel_charge,delete t.travel_distance,delete t.date,delete t.duration,delete t.running,delete t.user,delete t.project,delete t.package,"duration"===t.tracking.type?(delete t.tracking.start,delete t.tracking.end):(t.tracking.start=new m.vh("en-US").transform(t.tracking.start,"yyyy-MM-dd HH:mm"),t.tracking.end=new m.vh("en-US").transform(t.tracking.end,"yyyy-MM-dd HH:mm"),delete t.tracking.date,delete t.tracking.duration),t}putTimesheet(t){var e=this;return(0,o.A)(function*(){const r=e.prepareTimesheetForApi(t);return delete r.tracking.type,new Promise(function(){var i=(0,o.A)(function*(a){const n=yield e.http.post(e.baseUrl+"2.0/timesheet/"+t.id,r).toPromise();e.getMyTimesheets(!0),a(n)});return function(a){return i.apply(this,arguments)}}())})()}postTimesheet(t){var e=this;return(0,o.A)(function*(){const r=e.prepareTimesheetForApi(t);return delete r.id,new Promise(function(){var i=(0,o.A)(function*(a){const n=yield e.http.post(e.baseUrl+"2.0/timesheet",r).toPromise();e.getMyTimesheets(!0),a(n)});return function(a){return i.apply(this,arguments)}}())})()}deleteTimesheet(t){var e=this;return(0,o.A)(function*(){return new Promise(function(){var r=(0,o.A)(function*(i){yield e.http.delete(e.baseUrl+"2.0/timesheet/"+t).toPromise(),e.getMyTimesheets(!0),i()});return function(i){return r.apply(this,arguments)}}())})()}getTimesheetStatus(t=!1){var e=this;return(0,o.A)(function*(){return new Promise(function(){var r=(0,o.A)(function*(i,a){if(t||0===e.timesheetStatus.length)try{e.timesheetStatus=yield e.http.get(e.baseUrl+"2.0/timesheet_status").toPromise(),i(e.timesheetStatus)}catch(n){a(n)}else i(e.timesheetStatus)});return function(i,a){return r.apply(this,arguments)}}())})()}getClientService(t=!1){var e=this;return(0,o.A)(function*(){return new Promise(function(){var r=(0,o.A)(function*(i,a){try{(t||0===e.clientServicees.length)&&(e.clientServicees=yield e.http.get(e.baseUrl+"2.0/client_service").toPromise()),i(e.clientServicees)}catch(n){a(n)}});return function(i,a){return r.apply(this,arguments)}}())})()}getTimesheet(t,e=!1){var r=this;return(0,o.A)(function*(){return new Promise(function(){var i=(0,o.A)(function*(a){if(!e){const s=r.timesheets.filter(h=>h.id===t);if(1===s.length)return void a(s[0])}const n=yield r.http.get(r.baseUrl+"2.0/timesheet/"+t).toPromise();n.user=r.usersMap[n.user_id],n.project=r.projectMap[n.pr_project_id],n.package=r.cachedPackagesPackageId[n.pr_package_id],n.tracking=r.utilsService.prepareTracking(n.tracking),n.text=(new DOMParser).parseFromString(n.text,"text/html").documentElement.textContent,a(n)});return function(a){return i.apply(this,arguments)}}())})()}getMyTimesheets(t=!1){var e=this;return new Promise(function(){var r=(0,o.A)(function*(i){const a=yield e.getUser(),n=yield e.getTimesheets(a.id,t);t&&e.timesUpdated.next(null),i(n)});return function(i){return r.apply(this,arguments)}}())}searchContact(t){var e=this;return new Promise(function(){var r=(0,o.A)(function*(i,a){try{const n=e.http.post(e.baseUrl+"2.0/contact/search?limit=20",[{field:"name_1",value:t,criteria:"like"}]).toPromise(),s=e.http.post(e.baseUrl+"2.0/contact/search?limit=20",[{field:"name_2",value:t,criteria:"like"}]).toPromise();i([...yield n,...yield s])}catch(n){a(n)}});return function(i,a){return r.apply(this,arguments)}}())}getTimesheets(t=-1,e=!1){var r=this;return(0,o.A)(function*(){return new Promise(function(){var i=(0,o.A)(function*(a){if(e||0===r.timesheets.length){const n=[];if(t>-1){const s=[{field:"user_id",value:t,criteria:"="}];n.push(...yield yield r.http.post(r.baseUrl+"2.0/timesheet/search?order_by=date_desc&limit=50",s).toPromise())}else n.push(...yield r.http.get(r.baseUrl+"2.0/timesheet?order_by=date_desc").toPromise());for(let s=0;s<n.length;s++)n[s].user=r.usersMap[n[s].user_id],n[s].project=r.projectMap[n[s].pr_project_id],n[s].package=r.cachedPackagesPackageId[n[s].pr_package_id],n[s].tracking=r.utilsService.prepareTracking(n[s].tracking),n[s].text=(new DOMParser).parseFromString(n[s].text,"text/html").documentElement.textContent;r.timesheets=n}a(r.timesheets)});return function(a){return i.apply(this,arguments)}}())})()}getUsers(){var t=this;return new Promise(function(){var e=(0,o.A)(function*(r){r(t.users)});return function(r){return e.apply(this,arguments)}}())}getPackages(t=!1){var e=this;return(0,o.A)(function*(){yield e.getProjects(t);const r=[];for(let i=0;i<e.projects.length;i++){const a=e.projects[i].id,n=e.getPackagesForProject(a).then(s=>{e.cachedPackagesProjectId[a]=s;for(let h=0;h<s.length;h++)e.cachedPackagesPackageId[s[h].id]=s;e.packages.push(...s)});r.push(n)}yield Promise.all(r),yield e.getProjects(!0),e.projectsUpdated.next(null)})()}getPackageForProjectWithId(t,e){return console.log("getPackageForProjectWithId",t,e),this.http.get(this.baseUrl+"3.0/projects/"+t+"/packages/"+e).toPromise()}getPackagesForProject(t){return t?this.http.get(this.baseUrl+"3.0/projects/"+t+"/packages").toPromise():new Promise(e=>{e([])})}getUser(){var t=this;return(0,o.A)(function*(){return new Promise(function(){var e=(0,o.A)(function*(r){r(t.currentUser)});return function(r){return e.apply(this,arguments)}}())})()}}return(p=f).\u0275fac=function(t){return new(t||p)(l.KVO(P.Qq),l.KVO(d.AuthService),l.KVO(v.T))},p.\u0275prov=l.jDH({token:p,factory:p.\u0275fac,providedIn:"root"}),f})()},9893:(A,g,u)=>{u.d(g,{T:()=>v});var o=u(467),m=u(5083),l=u(6996),d=u(4742),y=u(3955);const{LocalNotifications:P}=m.ry;let v=(()=>{var _;class p{constructor(c,t,e){this.toastCtroller=c,this.alertController=t,this.translateService=e}static pad(c,t=2){let e=c+"";for(;e.length<t;)e="0"+e;return e}parseBexioDate(c){if(c&&-1===c.indexOf(" "))return new Date(c);const t=c.split(" ")[0],e=c.split(" ")[1].split(":").map(i=>parseInt(i,10)),r=new Date(t);return r.setHours(e[0],e[1],e[2]),r}prepareTracking(c){const t=(new Date).toISOString();return["date","start","end"].forEach(e=>{c[e]=c[e]?this.parseBexioDate(c[e]).toISOString():t}),c}requestNotificationPermission(){return new Promise(function(){var c=(0,o.A)(function*(t,e){(yield P.requestPermission())?e():t()});return function(t,e){return c.apply(this,arguments)}}())}parseDuration(c){return null===c?0:parseFloat(c)+parseFloat(c.split(":")[1])/60}showToast(c,t=3e3,e="top"){var r=this;return(0,o.A)(function*(){(yield r.toastCtroller.create({message:yield r.translateService.get(c).toPromise(),duration:t,position:e})).present()})()}confirm(c,t,e="Delete",r="Cancel"){var i=this;return new Promise(function(){var a=(0,o.A)(function*(n){(yield i.alertController.create({header:yield i.translateService.get(c).toPromise(),message:yield i.translateService.get(t).toPromise(),buttons:[{text:yield i.translateService.get(r).toPromise(),role:"cancel",cssClass:"secondary",handler:()=>{n(!1)}},{text:yield i.translateService.get(e).toPromise(),cssClass:"danger",handler:()=>{n(!0)}}]})).present()});return function(n){return a.apply(this,arguments)}}())}}return(_=p).\u0275fac=function(c){return new(c||_)(l.KVO(d.K_),l.KVO(d.hG),l.KVO(y.c$))},_.\u0275prov=l.jDH({token:_,factory:_.\u0275fac,providedIn:"root"}),p})()}}]);